if (document.addEventListener) {
  document.addEventListener('contextmenu', function(event) {
    event.preventDefault();
  }, false);
  document.addEventListener('click', function() {
    clearMenu();
  }, false);
} else {
  document.attachEvent('oncontextmenu', function() {
    window.event.returnValue = false;
  });
  document.attachEvent('onclick', function() {
    clearMenu();
  });
};

var tail_handle;
var my_tail_func = function(){
  var data = "";
  $.get(
    "/cwa_browser/tail", { 
      file : $('#selected_file').val()
    }, 
    function(data){ 
      $('#tail_content').val('');
      $('#tail_content').val(data);
    }
  );
  
  $("#tail_content").scrollTop($("#tail_content")[0].scrollHeight);
};

function rename(){
  var file_name = $('#selected_item').val();
  var show_name = file_name.split("/");
  var current_dir = "<%= @browser.current_dir %>";
  var input = prompt("Enter new file/directory name",show_name[show_name.length-1]);
  if (input != null && input != show_name){
    var new_name =  current_dir + "/" + input;
    window.location = "<%= request.path %>/rename?file=" + 
      encodeURIComponent(file_name) + 
      "&new_name=" + encodeURIComponent(new_name) + "&dir=" + encodeURIComponent("<%= @browser.current_dir %>");
  }
};

function createDirectory(){
  var current_dir = "<%= @browser.current_dir %>";
  var new_dir = prompt("Enter new directory name");
  if (new_dir){
    window.location = "<%= request.path %>/mkdir?new_dir=" + 
      encodeURIComponent(new_dir) + "&dir=" + encodeURIComponent("<%= @browser.current_dir %>");
  }
};

function deleteItem(){
  var file_name = $('#selected_item').val();
  var show_name = file_name.split("/");
  var queryString = $('#app_form').serialize();
  if (confirm("Are you sure you want to delete " + show_name[show_name.length-1] + "?")) {
    window.location = "<%= request.path %>/delete?file=" + encodeURIComponent(file_name) + 
      "&dir=" + encodeURIComponent("<%= @browser.current_dir %>");
  }
};

function chdir(elem){
  window.location = "<%= request.path %>?dir=" + encodeURIComponent(elem.id);
};

function back(){
  window.location = "<%= request.path %>?dir=" + encodeURIComponent("<%= @browser.up_dir %>");
};

// Dustin Diaz's getElementsByClass to search for elements by class name regex
function getElementsByClass(searchClass,node,tag) {
  var classElements = new Array();
  if ( node == null )
    node = document;
  if ( tag == null )
    tag = '*';
  var els = node.getElementsByTagName(tag);
  var elsLen = els.length;
  var pattern = new RegExp(searchClass);
  for (i = 0, j = 0; i < elsLen; i++) {
    if ( pattern.test(els[i].className) ) {
      classElements[j] = els[i];
      j++;
    }
  }
  return classElements;
}

function clear_selected(){
  var selected = getElementsByClass("^.*(File|Dir).*Selected$"),
    items = selected.length,
    element = null;
  for (var i = 0; i < items; i++){
    element = selected[i];
    new_name = element.className.replace("Selected","");
    element.className = new_name;
  }
}

function select_directory(elem){
  var className = elem.className;
  var re = new RegExp(".*Selected$");
  if (!elem.className.match(re)){
    clear_selected();
    elem.className = className + "Selected";
  }
  $("#selected_dir").val(elem.id);
  $("#selected_item").val(elem.id);
}

function select_file(elem) {
  var className = elem.className;
  var re = new RegExp(".*Selected$");
  if (!elem.className.match(re)){
    clear_selected();
    elem.className = className + "Selected";
  }
  $("#selected_file").val(elem.id);
  $("#selected_item").val(elem.id);
}

function download_file(elem){
  window.location.assign("<%= request.path %>/download?file=" + encodeURIComponent($('#selected_item').val()));
}

function download_zipfile(elem){
  window.location.assign("<%= request.path %>/download_zip?file=" + encodeURIComponent($('#selected_item').val()));
}

function showMenu(event, elementId) {
  /*  check whether the event is a right click 
   *  because different browser (ahem IE) assign different numbers to the keys to
   *  your mouse buttons and different values to the event, you'll have to do some evaluation
   */
  var rightclick; //will be set to true or false
  if (event.button) {
    rightclick = (event.button == 2);
  }
 
  if(rightclick) { //if the secondary mouse botton was clicked
    var menu = document.getElementById(elementId);
    menu.style.display = "block"; //show menu

    var x = event.clientX; //get X and Y coordinance for menu position
    var y = event.clientY;
 
    //This section is necessary if you click on the far right edge or bottom
    //The 200 is arbitrary, choose whatever number you want based on how large your menu is
    if(window.innerWidth) {
      windowWidth = window.innerWidth;
      windowHeight = window.innerHeight;
    } else if(document.documentElement.clientWidth) {
      windowWidth = document.documentElement.clientWidth;
      windowHeight = document.documentElement.clientHeight;
    } else {
      windowWidth = document.getElementsByTagName('body')[0].clientWidth;
      windowHeight = document.getElementsByTagName('body')[0].clientHeight;
    }
    if(windowWidth < (x + 200)) {
      x = x - 200;
    }
    if(windowHeight < (y + 200)) {
      y -= 200;
    }
 
    //position the menu
    menu.style.position = "fixed"; // use fixed or it will not work when the window is scrolled
    menu.style.top = y+"px";
    menu.style.left= x+"px";
  }
}
 
function clearMenu() { //used to make the menu disappear
  //this function should be used at the beginning of any function that is called from the menu
  var menu = document.getElementById('menuDir');
  if (menu) {
    menu.style.display = "none"; //don't show menu
  }
  var menu = document.getElementById('menuFile');
  if (menu) {
    menu.style.display = "none"; //don't show menu
  }
}

function showUploadFile(){
  var menu = document.getElementById('upload');
  menu.style.display = "block"; //don't show menu
}

function hideUploadFile(){
  var menu = document.getElementById('upload');
  menu.style.display = "none"; //don't show menu
}

function showTextEditor(){
  var menu = document.getElementById('textEditor');
  menu.style.display = "block"; //don't show menu
}

function hideTextEditor(){
  var menu = document.getElementById('textEditor');
  menu.style.display = "none"; //don't show menu
  document.getElementById("new_file_form").reset();
}

function showTail(){
  $('#tail').css('display', "block"); // show tail box
  my_tail_func();
  tail_handle = setInterval(my_tail_func, 5000);
}

function hideTail(){
  $('#tail').css('display', "none"); //don't show tail box
  document.getElementById("tail_box").reset;
  clearInterval(tail_handle);
}
